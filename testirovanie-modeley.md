---
order: 11
title: Тестирование данных
---

Помимо разработки, одной из важнейших задач при работе с хранилищами данных является обеспечение качества и целостности данных. Для этого проводится тестирование, при котором выявляют аномалии и ошибки.

Понятно, что данные можно проверять точечно и вручную, но  автоматизированое тестирование позволяет сократить количество ошибок, укрепить доверие к данным и сократить трудозатраты разработчиков и аналитиков на эту операцию.

В данном разделе рассмотрим возможности dbt в части тестирования.

Тестирование в dbt – это выполнение определенных настроек в моделях, а также в других объектах проекта (источниках, CSV-файлах, «снэпшотах»), которые позволяют проверить целостность данных, а затем сообщить о результатах этих проверок.

В dbt тесты являются SQL-запросами, направленными на поиск «ошибочных» записей.

Например, если в настройках указано, что столбец (или поле) модели является уникальным, то тестовый запрос выбирает дубликаты. Если, согласно настройкам, столбец никогда не бывает нулевым, то тест ищет записи с нулевым значением этого столбца. Другими словами, если тестовый запрос не возвращает никаких записей, то тест считается успешно пройденным.

Данные в dbt  можно протестировать с помощью встроенной функциональности, а также с применением дополнительных библиотек («пакетов»).

В dbt существует два вида тестов:

-  тесты данных (data tests), которые помогают обеспечить качество данных;

-  модульные тесты (unit tests, возможно, удобнее их называть просто юнит-тесты), которые проверяют заложенную в модели логику.

Рассмотрим каждый из этих видов подробнее.

## Тесты данных (data tests)

Тесты данных (data tests) предназначены для проверки целостности данных при каждом запуске проекта.

При этом тесты на уровне данных бывают единичными (singular tests) и общими  (generic tests).

#### Единичные тесты (singular tests)

Возможно, по-русски звучит как-то криво, но смысл названия в том, что этот тип тестов используется для какой-то одной конкретной цели. Он достаточно прост и содержит один единственный SELECT, который возвращает «ошибочные» записи. В этих тестах можно использовать  функциональность Jinja, как в dbt-моделях.

Единичные тесты располагаются в папке `tests` и выполняются автоматически при запуске команды `dbt test`.

Какие-то строгие правила наименования здесь не применяются. Главное, чтобы название теста отражало суть выполняемых в нем действий.

Итак, давайте напишем первый незамысловатый тест - проверим, что в данных отсутствуют отрицательные суммы по оплате.

Создайте в папке `tests` файл `check_payment_total_amount_is_positive.sql` и добавьте в него следующий код:

```sql
select

    payment_id,
    sum(amount) as total_amount

from {{ ref('fct_payments') }}

group by 1

having total_amount < 0
```

<note type="lab" title="Примечение">

Не ставьте точку с запятой (;) в конце `select` единичного теста, иначе он свалится в ошибку.

</note>

![](./testirovanie-modeley.png "Рисунок 44. Добавление единичного теста (singular tests)"){width=1672px height=888px}

Так как с помощью тестов мы хотим упростить себе жизнь, то этих тестов может быть достаточно большое количество. Да, ранее было отмечено, что название теста должно отражать его суть, но дополнительные уточняющие комментарии не помешают, чтобы не запутаться. Для этого применяются настроечные YAML-файлы.

Создайте в папке `tests` файл `description.yml` и добавьте в него следующее содержимое:

```yaml
version: 2
data_tests:
  - name: check_payment_total_amount_is_positive
    description: >
    Оплата за аренду автомобиля всегда имеет положительное значение (>= 0).
	Выборка записей, в которых общая сумма < 0, завершит тест с ошибкой.
```

<note type="lab" title="Примечание">

Название настроечного YAML-файла с комментариями может быть совершенно любым. Здесь самое главное, чтобы наименования тестов соответствовали наименованиям SQL-файлов с логикой тестов.

Небольшой комментарий про тег `version: 2`. Эта настройка была обязательной для версии dbt 1.4 и ниже. Сейчас она не обязательна, но все-таки разработчики рекомендуют оставить ее.

</note>

## Модульные тесты (unit tests)