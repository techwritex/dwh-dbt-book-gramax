---
order: 9
title: Создание моделей промежуточного слоя (intermediate)
---

Перед тем, как перейти к созданию моделей вспомните подход к структурированию объектов промежуточного слоя и задачу учебного проекта.

Структура подпапок промежуточного слоя ориентирована на бизнес-структуру. Другими словами, если потребителями данных являются несколько подразделений компании, то в папке `intermediate` рекомендуется создать отдельные вложенные папки для хранения моделей для каждого из этих подразделений. В том случае, если имеются «общие» модели, которые используются всеми (или несколькими) подразделениями, то создайте для них отдельную вложенную в intermediate папку.

## Структура слоя

Исходя из задачи учебного проекта, создайте вложенные папки в  `intermediate`:

-  `core` – для хранения «общих» моделей,

-  `finance` – для хранения моделей финансового отдела.

## Модели слоя

### Общие модели

Одна из основных сущностей, которая может быть использована различными подразделениями компании – заказчики (customers). Сама данная сущность будет создана на слое витрин, а промежуточный слой – место для преобразования данных для этой сущности.

На staging-слое есть модель `stg_pg__customers.sql`, которая содержит отдельные поля с именами и фамилиями заказчиков – `first_name` и `last_name`. Но по отдельности такие поля в аналитике практически не используются. В связи с этим, выполните первое простое преобразование данных на промежуточном слое – объединение этих двух полей.

Напомню, что dbt-модели создаются с помощью обобщенных табличных выражений (CTE). В общем виде модель промежуточного слоя выглядит следующим образом:

```sql
with имя-cte as (

    select

        (перечень полей staging-модели)

    from {{ ref('имя-staging-модели') }}

)

select * from имя-cte
```

Создайте в папке `models/intermediate/core/` файл (в соответствие с правилами наименования) `int_customers_name_concatenated.sql` и добавьте код:

```sql
with customers as (

    select

        customer_id, 
        concat(first_name,' ',last_name) as full_name, 
        gender, 
        driving_licence_number, 
        driving_licence_valid_from, 
        phone, 
        email, 
        updated_at

    from {{ ref('stg_pg__customers') }}

)

select * from customers
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed.png "исунок №. Промежуточная модель заказчиков"){width=1892px height=946px}

Пусть это достаточно простой пример, но на нем вы увидели не менее простой принцип создания модели промежуточного слоя dbt-проекта.

Вторая общая сущность в платформе данных каршеринговой компании – автомобили (cars). В исходных данных к этой сущности можно отнести две таблицы – `car` (информация об автомобилях компании) и `category` (категория автомобилей – стандарт, комфорт, бизнес и т.д.).

Для создания обобщенной модели с данными об автомобилях обогатите данные таблицы `car` данными таблицы `category`.

Создайте в папке `models/intermediate/core/` файл (по правилами наименования) `int_cars_joined_to_categories.sql`.

Сделайте выборку данных из каждой staging-модели, а затем соедините:

```sql
with cars as (

    select 

        car_id, 
        brand, 
        model, 
        category_id, 
        car_year, 
        vin, 
        licence_plate, 
        mileage

    from {{ ref('stg_pg__cars') }}

),

categories as (

    select

        category_id, 
        category_text, 
        rate

    from {{ ref('stg_pg__categories') }}

), 

cars_joined_to_categories as (

    select

        cars.car_id, 
        cars.brand, 
        cars.model, 
        categories.category_text, 
        categories.rate,
        cars.car_year, 
        cars.vin, 
        cars.licence_plate, 
        cars.mileage

    from cars

    left join categories
    on cars.category_id = categories.category_id

)

select * from cars_joined_to_categories
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-2.png "Рисунок №. Промежуточная модель автомобили"){width=1860px height=1002px}

На промежуточном слое в качестве источников могут использоваться не только staging-модели, но и модели непосредственно промежуточного слоя. Примените эту идею в создании третьей общей сущности в платформе данных – бронирования (bookings). Как правило, бронирование содержит информацию о субъекте и объекте брони и будем считать эту сущность эквивалентом заказа. Применительно к учебному проекту модель бронирования должна быть представлена в разрезе заказчика и автомобиля.

Для создания этой модели используйте staging-модель с бронированиями, а также созданные на предыдущих шагах модели промежуточного слоя.

Создайте в папке `models/intermediate/core/` файл  `int_bookings_joined_to_customers_and_cars.sql` и добавьте следующий код:

```sql
with bookings as (

    select 

        booking_id,
        created_at,
        customer_id,
        car_id

    from {{ ref('stg_pg__bookings') }}

),

customers as (

    select

        customer_id, 
        full_name, 
        gender, 
        driving_licence_number, 
        driving_licence_valid_from, 
        phone, 
        email, 
        updated_at

    from {{ ref('int_customers_name_concatenated') }}

),

cars as (

    select 

        car_id, 
        brand, 
        model, 
        category_text, 
        rate,
        car_year, 
        vin, 
        licence_plate, 
        mileage

    from {{ ref('int_cars_joined_to_categories') }}

),

bookings_joined_to_customers_and_cars as (

    select

        bookings.booking_id,
        bookings.created_at,
        customers.customer_id, 
        cars.car_id

    from bookings

    left join customers
    on bookings.customer_id = customers.customer_id

    left join cars
    on bookings.car_id = cars.car_id

)

select * from bookings_joined_to_customers_and_cars
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-3.png "Рисунок №. Промежуточная модель бронирования"){width=2042px height=1034px}

С «общими» моделями разобрались. Пришло время модели финансового отдел, которая в конечном счете трансформируется в таблицу фактов.

### Модели финансового отдела

Итак, что наиболее важное для финансового отдела, в частности, каршеринговой компании? Скорее всего оплата бронирования (аренды) автомобиля. Но сама по себе оплата, или приход денежных средств, мало, о чем говорит. Хотя этого может быть и достаточно, но по условной задаче сотрудники финансового отдела желают проводить аналитическую работу. Так вот для детального анализа нужна привязка оплаты к субъекту и объекту. Другими словами, оплата должна быть предоставлена в разрезе заказчика и автомобиля.

Источниками для данной модели может быть staging-модель с данными по оплате и только что созданная промежуточная модель с информацией по бронированиям автомобилей.

Создайте в папке `models/intermediate/finance/` файл  `int_payments_joined_to_bookings.sql` и добавьте следующий код:

```sql
with payments as (

    select 

        payment_id, 
        created_at, 
        booking_id, 
        amount

    from {{ ref('stg_pg__payments') }}

),

bookings as (

    select

        booking_id, 
        created_at, 
        customer_id,
		car_id

    from {{ ref('int_bookings_joined_to_customers_and_cars') }}

),

payments_joined_to_bookings as(

    select 

        payments.payment_id, 
        payments.created_at, 
        bookings.customer_id,
        bookings.car_id, 
        payments.amount

    from payments

    left join bookings
    on payments.booking_id = bookings.booking_id

)

select * from payments_joined_to_bookings
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-4.png "Рисунок №. Промежуточная модель для финансового отдела"){width=1974px height=976px}

### Модели для календаря

Помимо основных бизнес-сущностей в аналитике данных используется календарь для добавления разреза данных по различным временным периодам. В частности, в учебном проекте требуется добавить разрез по году, месяцу, неделе и дню. Существует несколько способов создания такого календаря, который в рамках хранилища станет измерением «Дата». Понятно, что данное измерение не относится только к конкретному подразделению и может быть использовано в различных витринах. Но есть одна причина, по которой я вынес эту материал в отдельный раздел.

Итак, если говорить про dbt в части календаря, то можно пойти следующими путями:

-  загрузить вручную таблицу с нужными данными по календарю в папку `seeds` ([через csv-файл](./razvertyvanie-dbt-proekta#seeds)),

-  воспользоваться готовой библиотекой (в dbt они называются packages).

Первый вариант достаточно простой и понятный.  С точки зрения ознакомления с возможностями dbt второй вариант более интересный, поэтому на нем и остановимся.

#### dbt packages

Несколько слов о dbt packages (или dbt библиотеках).

Что такое dbt package? Возможно, это покажется невероятным, но это всего лишь обычный dbt-проект, который, как правило, хранится в git-репозитории. И «пакетом» он становится, когда импортируется в другой проект. Содержимое этих проектов (макросы, тесты, модели и т.д.) может быть переиспользовано в других проектах и позволяет избежать «изобретение велосипеда».

Существует огромное количество библиотек, созданных сообществом. Портал, где представлены библиотеки, называется Package Hub и расположен по адресу [https://hub.getdbt.com](https://hub.getdbt.com/).

Для наших целей импортируем одну из наиболее часто используемых библиотек `dbt-utils`.

#### dbt-utils

`dbt-utils` -- это библиотека, созданная разработчиками dbt Labs. Она содержит широкий набор функций и макросов, которые помогают оптимизировать различные задачи в dbt-проектах. Но сейчас нам потребуется один из макросов, который работает с календарем. Этот макрос называется `date_spine`. Актуальная версия находится по ссылке <https://hub.getdbt.com/dbt-labs/dbt_utils/latest/>.

Пакеты импортируются очень просто, буквально в три шага (в первый раз, затем всего два шага).

Создайте файл `packages.yml` на том же уровне проекта, где расположен файл `dbt_project.yml`.

Добавьте в новый файл название «пакета» и его версию (посмотрите актуальную версию на странице библиотеки):

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.3.0
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-5.png "Рисунок №. Настойка библиотеки (пакета)"){width=1446px height=848px}

Для установки «пакета» выполните следующую команду:

```bash
dbt deps
```

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-6.png "Рисунок №. Запуск установки пакетов"){width=965px height=341px}

В результате установки пакетов в структуре проекта создается папка `dbt_packages` с вложенной папкой самой библиотеки (в данном случае `dbt_utils`).

![](./sozdanie-modeley-promezhutochnogo-sloya-intermed-7.png "Рисунок №. Добавление в структуру проекта папки с библиотеками."){width=1532px height=932px}

## Запуск проекта и обновление хранилища

Таким образом, вы подготовили промежуточные модели, которые будут использоваться для создания витрин. Это конечно же не все модели, которые можно создать на основе данных системы-источника. При желании вы можете создать дополнительные модели для сотрудников вымышленной компании Carsharing, а пока запустите движок dbt, чтобы создать объекты промежуточного слоя в хранилище.

Выполните команду запуска проекта:

```bash
dbt run
```