---
order: 12.5
title: История изменений данных
---

Одна из основных концепций хранилищ данных  - это хранение и обработка данных не только за текущий период, но и за предыдущие. Для владельцев и пользователей различных аналитических систем важно понимать как изменялись данные с течением времени. Для этих целей, как уже было отмечено ранее, в dbt™ реализована функциональность [«снэпшотов»](./razvertyvanie-dbt-proekta#snapshots).

Напомню, что в отличие от моделей, которые всегда содержат только актуальное (текущее или последнее) состояние данных, «слепки»  («снэпшоты», «слепки» и «снимки» часто используются в качестве синонимов) позволяют вести версионность данных, то есть отслеживать изменение данных  без потери предыдущих состояний.

|                | Стандартные модели                                 | Снэпшоты                                                       |
|----------------|----------------------------------------------------|----------------------------------------------------------------|
| Назначение     | Преобразование данных на основе текущего состояния | Отслеживание изменений данных                                  |
| Материализация | Таблицы или представления с текущими данными       | Таблицы истории, доступные только для добавления (append-only) |

## Механизм формирования «снэпшотов»

«Спэпшоты» создаются при выполнении комады `dbt snapshot`. В момент запуска создается первый «слепок», повторяющий структуру исходной таблицы, изменение которой планируется отслеживать, с дополнительными столбцами, включая `dbt_valid_from` и `dbt_valid_to`. При этом у всех записей `dbt_valid_to` будет иметь значение `null`.

При последующих запусках dbt™ проверяет, какие существующие записи изменились и были ли созданы новые. Если какая-то существующая запись изменилась, то `dbt_valid_to` обновит значение, а изменения запишутся в новую строку со значением `dbt_valid_to` = `null`. Новая запись, которой ранее не было тоже будет иметь значение `dbt_valid_to` = `null`.

Также стоит упомянуть о стратегиях выявления изменений.

Таких стратегий всего две:

-  временная метка (`timestamp`), которая использует столбец `updated_at` для определения изменения записи;

-  проверка (`сheck`), которая сравнивает текущие и предыдущее значения столбцов таблицы, чтобы определить, изменилась ли запись.

## Стратегия временной метки (timestamp)

Стратегия временных меток используется, когда исходные записи содержат поле, которое обновляется при каждом изменении (например, столбец `last_update`). Движок dbt™ использует этот столбец, чтобы определить, изменилась ли запись с момента последнего запуска «снэпшота».

Чтобы использовать данную стратегию, необходимо указать столбец в настройках «слепков». dbt™ сравнивает предыдущее значение с текущим значением при каждом запуске. Если временная метка изменилась, dbt™ рассматривает запись как обновленную, завершает предыдущую версию и вставляет новую запись.

Эта стратегия эффективна, однако требует наличия надежного и постоянно обновляемого столбца временных меток в исходных данных. Если временная метка не изменяется при изменении данных, то dbt™ не выполнит обновление «снэпшота».

## Стратегия проверки (сheck)

Стратегия проверки применяется в случаях, когда в исходной таблице отсутствует столбец с датой/временем обновления. Эта стратегия работает путем сравнения одного или нескольких столбцов между их текущими и предыдущими значениями (например, `check_cols = ["phone", "email"]`). Если значение в записи какого-либо из этих столбцов изменилось, то dbt™ аннулирует старую запись и запишет новую. Если значения столбцов идентичны, dbt™ не будет предпринимать никаких действий.

Данная стратегия может быть более затратной с точки зрения вычислений, особенно для широких таблиц или больших наборов данных. Важно выбирать только те столбцы, которые, как ожидается, могут измениться, чтобы избежать ненужного управления версиями. Поэтому разработчиками dbt™ рекомендовано использование стратегии временных меток, так как при этой стратегии требуется отслеживать только одну колонку (`updated_at`), а также уменьшается вероятность возникновения ошибок (например, если несвоевременно будет обновлена настройка стратегии при изменении схемы таблицы, когда добавляются/удаляются столбцы, участвующие в формировании «слепков»).

<note title="Важно">

В случае использования стратегии проверки может возникнуть соблазн настроить для отслеживания изменений все столбцы исходной таблицы, указав `check_cols = «all»`. Хотя такая настройка является штатной, но разработчики dbt™ все-таки рекомендуют перечислять конкретные столбцы, которые необходимо проверять, или же рассмотреть возможность использования суррогатного ключа по нескольким столбца. Затем этот ключ указывать в настройках формирования «снэпшота».

</note>

## Процесс построения «снэпшотов»

Процесс построения «снэпшота» в dbt™ содержит следующие этапы:

1. Определение источника.

2. Настройка и построение модели «снэпшота».

3. Запуск «снэпшота».

### Определение источника

В качестве источника для «снэпшотов» используются модели staging-слоя. На примере одной из исходных моделей проекта отследим изменение контактной информации заказчиков (`stg_pg__customers`).

### Настройка и построение модели «снэпшота»

<note type="lab" title="Примечение">

До версии dbt™ 1.9 существовала возможность конфигурации «снэпшотов» только через SQL синтаксис. Но начиная с версии 1.9, можно обойтись настройками с помощью YAML.

Рекомендую обновить версию (минимум до 1.9) перед началом работы со «снэпшотами».

</note>

Создайте в папке `snapshots` файл `customers_snapshot.yml` и добавьте в него следующий код:

```yaml
snapshots:
  - name: customers_snapshot
    relation: ref('stg_pg__customers')
    config:
      schema: snapshots
      unique_key: customer_id
      strategy: timestamp
      updated_at: updated_at
      dbt_valid_to_current: "to_date('9999-12-31')" # Specifies that current records should have `dbt_valid_to` set to `'9999-12-31'` instead of `NULL`.
```

### Запуск «снэпшота»

«Снэпшоты» не совсем обычные модели. Как было отмечено ранее, в проекте они хранятся не в общей папке `models`, а в отдельной `snapshots`. Более того, для них создается отдельная схема, что является своего рода «защитой от дурака» -- потенциального удаления этих таблиц. Поэтому «снэпшоты» создаются отдельной командой `dbt snapshot` (или же в рамках общей сборки проекта `dbt build`).